和卡尔曼滤波差不多，互补滤波的核心思想在于​​融合多个传感器的数据，发挥各自优势，弥补各自劣势。他的目标也就是融合两种（或多种）具有​**​互补噪声特性​**​的传感器数据，以获得对同一物理量（通常是角度或位置）​更优的估计

按照惯例，我们先用人话概括一下：​假设我有两路信号，一个带有高频噪声，一个带有低频噪声，所以我把他们的噪声分别滤除，然后合并，就得到了没有噪声的原始信号。

因为互补滤波这个东西一般用来做姿态解算，因此我们就用姿态解算作为例子来深入了解一下他的原理。请注意，我们所熟知的Mahony算法其实也是互补滤波，不过他是优化过的非线性互补滤波，不要混淆了。

# 一些基本概念

- **高通滤波**：高通滤波器允许信号中​**​高于​**​某个特定频率（​**​截止频率​**​）的成分​**​相对容易地通过​**​，而对​**​低于​**​截止频率的成分进行​**​衰减（减弱）**。这样可以**​**​突出信号中快速变化的部分。
- **低通滤波**：低通滤波就反过来，让低频的过，滤去高频信号。这样的信号更平滑。

# Previously

**陀螺仪**用来测量角速度。积分可得角度变化。优点是​**​动态响应好​**​（高频信息准确），缺点是因为积分，测量中的微小​**​零偏误差​**​会随时间​**​累积​**​（积分漂移），导致​**​低频信息不可靠​**​（长期估计发散）。

**加速度计**测量三轴加速度（包括重力加速度）。在​**​物体相对静止或慢速运动​**​时，可以通过重力矢量分量计算出​**​绝对倾角​**​。优点是​**​低频信息准确​**​（长期估计稳定，无累积误差），缺点是对​**​高频振动/运动​**​非常敏感（高频噪声大），导致​**​高频信息不可靠​**​（瞬时估计噪声大、可能错误）。

综上，我们其实可以看出这两种数据其实是存在互补性的，也就是我们可以拿陀螺仪的高频部分和加速度计的低频部分来实现互补，融合出一个更好的姿态估计数据。但是，真是这样吗？

# 符号

- $w$：表示角速度

# 线性互补滤波

很显然，我们首先可以知道这样的关系式：
$$angle = angle_{0} + w t$$
这样我们就能根据这个角速度算出当前的角度。但是初始状态呢？

我们假设刚开始的时候，物体处于静止的状态，因此在世界坐标系下，我们只有z轴有加速度且为g，其他轴加速度为0。因此我们可以得出：

$$
\begin{aligned}
\begin{bmatrix}
a_x \\
a_y \\
a_z
\end{bmatrix} &= C_n^b \begin{bmatrix}
0 \\
0 \\
g
\end{bmatrix} \\
&= \begin{bmatrix}
\cos \psi \cos \theta & \sin \psi \cos \theta & -\sin \theta \\
\cos \psi \sin \theta \sin \gamma - \sin \psi \cos \gamma & \sin \psi \sin \theta \sin \gamma + \cos \psi \cos \gamma & \cos \theta \sin \gamma \\
\cos \psi \sin \theta \cos \gamma + \sin \psi \sin \gamma & \sin \psi \sin \theta \cos \gamma - \cos \psi \sin \gamma & \cos \theta \cos \gamma
\end{bmatrix} \begin{bmatrix}
0 \\
0 \\
g
\end{bmatrix} \\
&= \begin{bmatrix}
-\sin \theta g \\
\cos \theta \sin \gamma g \\
\cos \theta \cos \gamma g
\end{bmatrix}
\end{aligned}
$$

所以：

$$
\begin{aligned}
angle_{pitch} &= \arcsin(\frac{-a_{x}}{g})\\
angle_{roll} &= \arctan(\frac{a_{y}}{a_{z}})
\end{aligned}
$$

至于yaw角，如果没有磁力计，我们就只能积分z轴角速度。这没办法。

到此，我发现这没有互补，哪来的互补，不就一路输出吗？其实我们这里需要首先给出一些假设：

- 物体运动的时候基本可以认为是受力平衡的，

### 线性互补滤波器在姿态解算中的详细推导与解释

姿态解算的核心问题是如何融合​**​陀螺仪​**​（高频信号准确，但有累积漂移）和​**​加速度计​**​（低频信号稳定，但易受运动干扰）的数据。线性互补滤波器通过频率分割，将两者的优势互补：

```
姿态 = 高通滤波(陀螺仪) + 低通滤波(加速度计)
```

---

#### 一、核心模型推导

##### 1. 问题定义

- ​**​陀螺仪​**​输出角速度 ω(t)，积分后得姿态角 θg​(t)：
    θg​(t)=∫0t​ω(τ)dτ
    高频响应好，但积分会累积误差（漂移）。
- ​**​加速度计​**​在静态时通过重力分量计算姿态角 θa​(t)：
    θa​(t)=tan−1(az​ay​​)(滚转示例)
    低频稳定，但动态时受线性加速度干扰。

##### 2. 连续域互补滤波器设计

在拉普拉斯域（s域）设计：

θ(s)=高通s+Ks​​​⋅sω(s)​+低通s+KK​​​⋅θa​(s)

- ​**​高通部分​**​：s+Ks​ 保留陀螺仪高频信号（快速响应）。
- ​**​低通部分​**​：s+KK​ 保留加速度计低频信号（抑制漂移）。

化简为：

θ(s)=s+Kω(s)+Kθa​(s)​

对应的微分方程为：

θ˙(t)+Kθ(t)=ω(t)+Kθa​(t)

##### 3. 离散化实现

采用前向欧拉法（采样周期 T）：

s≈T1−z−1​

代入传递函数并离散化：

θ(z)=1−αz−1(1−α)θa​(z)+αTω(z)​,α=1+KT1​

递推形式（实时更新）：

θk​=α(θk−1​+Tωk​)+(1−α)θa,k​

- α：滤波器系数（0∼1），控制截止频率。
- T：采样时间（秒）。

---

#### 二、关键参数设计

- ​**​截止频率 K​**​：
    K=2πfc​(fc​:截止频率, Hz)
    典型值：fc​=0.5−5Hz（折中陀螺与加速度计优势频段）。
- ​**​系数 α​**​：
    α=1+2πfc​T1​
    ​**​示例​**​：若 fc​=1Hz, T=0.01s，则 α≈0.94。  
     (α≈1 时更信任陀螺仪；α≈0 时更信任加速度计)。

---

#### 三、姿态解算步骤

1. ​**​初始化​**​：

    - 读取加速度计数据 (ax​,ay​,az​)。
    - 计算初始姿态：
      {roll0​=tan−1(ay​/az​)pitch0​=tan−1(−ax​/ay2​+az2​​)​

2. ​**​循环更新​**​（每次采样）：

    - 读取陀螺仪 (ωx​,ωy​) 和加速度计 (ax​,ay​,az​)。
    - ​**​计算加速度计姿态​**​：
      {rolla​=tan−1(ay​/az​)pitcha​=tan−1(−ax​/ay2​+az2​​)​
    - ​**​更新滚转 & 俯仰角​**​：
      {rollk​=α(rollk−1​+T⋅ωy​)+(1−α)rolla​pitchk​=α(pitchk−1​+T⋅ωx​)+(1−α)pitcha​​

---

#### 四、关键要点

1. ​**​系数 α 的作用​**​：

    - α≈1（如 0.95）：信任陀螺仪，响应快但漂移大。
    - α≈0（如 0.05）：信任加速度计，抗漂移但动态响应差。

2. ​**​加速度计姿态计算注意事项​**​：

    - 需归一化：g=ax2​+ay2​+az2​​，计算前除以 ∣g∣。
    - 当 az​≈0 时（如横滚角接近 ±90°），计算会失效（需特殊处理）。

3. ​**​陀螺仪数据的角速度关系​**​：

    - 绕机体 Y 轴的角速度 ωy​ → 影响滚转角（roll）。
    - 绕机体 X 轴的角速度 ωx​ → 影响俯仰角（pitch）。

4. ​**​优缺点​**​：

    - ✅ 计算简单（仅乘加运算），实时性强。
    - ✅ 无状态矩阵，无需卡尔曼增益调整。
    - ❌ 欧拉角奇点问题（横滚 ±90° 时失效）。
    - ❌ 忽略陀螺-加速度计的轴间耦合（适用于小角度）。

---

#### 五、优化方向

1. ​**​大角度处理​**​：

    - 改用​**​四元数互补滤波器​**​（如 Mahony 滤波），避免欧拉角奇点。
    - 示例：
      q˙​=21​q⊗[0ω​]−β∇J(梯度下降融合加速度计)

2. ​**​动态干扰抑制​**​：

    - 加速度计可靠性检测：当 ∣a∣≈g 时，增大 α（更信任陀螺仪）。

3. ​**​零偏校正​**​：

    - 陀螺仪零偏在线估计：静态时，ω≈0 应满足 ωbias​→ωmeasure​。

---

线性互补滤波器通过简明的频域分割，解决了MEMS传感器姿态估计的核心矛盾。其工程实现容易，是无人机、机器人等实时系统的首选方法。对于更高精度需求，可扩展为非线性互补滤波（如Mahony）或卡尔曼滤波。
