#计算机网络

# 什么是数据链路层

首先我们需要知道数据链路层这个玩意是干啥的。数据链路层是计算机网络中负责在两台直接相连设备之间传输数据的层，它位于物理层之上，网络层之下。它的核心任务是确保数据从一台设备可靠地传输到另一台设备。

省流一下就是主要解决三个问题：`封装成帧`、`透明传输`和`差错检测`。

他的工作确保了网络通信的基础，使上层协议能够在稳定的链路上进行有效的数据交换。

# 什么是透明传输

**透明传输** 是数据链路层的一项关键特性，简单来说就两个作用：确保数据完整、对上层协议透明。

## 为什么叫透明

在**透明传输**中，"透明"这个词指的是数据链路层对数据的处理是**无缝的**，即数据传输的过程对上层协议和应用程序是**透明的**，它们不需要知道链路层的内部处理细节。

链路层处理数据时，不会干扰或改变数据的内容，也不会让上层协议感知到数据在链路层传输过程中所做的任何操作。

## 为什么需要透明传输

在数据链路层进行数据传输时，通常会使用某些特殊的控制字符来标识数据帧的**开始**和**结束**（例如 `01111110` 作为以太网帧的边界标识）。如果传输的数据本身包含了这些特殊字符，链路层可能误将数据中的内容当作帧的开始或结束标识，从而导致数据解析错误或丢失。

**透明传输** 就是为了避免这种情况发生，它确保无论数据中包含什么内容，链路层都能正确地识别数据帧的边界，并且不受到数据本身的干扰。

## 透明传输是如何实现的？

透明传输通常通过 **位填充（Bit Stuffing）** 或 **字符填充（Byte Stuffing）** 技术来实现。

### 1. **位填充（Bit Stuffing）**

位填充是在数据中插入额外的比特（通常是 `0`），避免数据中出现连续的特殊标志位模式（如“11111”）。这样就能确保这些标志位不会被误判为帧的开始或结束标志。

#### 工作原理

-   假设链路层用一个特定的比特模式（例如连续的 5 个 `1` 比特 `11111`）作为帧的开始和结束标志。
-   如果数据中包含了连续的 `11111`，链路层会在该模式后插入一个 `0`，打破连续的 `1`，避免它被误认为是帧的边界。
-   接收方收到数据时，会去掉多余的 `0`，还原原始数据。

#### 举个例子

-   如果数据流中有 `11111`，而 `11111` 作为帧的边界标志，链路层会在其后插入一个 `0`，变成 `111110`
-   接收方在解码时，去掉多余的 `0`，还原为 `11111`。

### 2. **字符填充（Byte Stuffing）**

字符填充是在数据流中插入特定的转义字符，避免数据中包含链路层的帧边界字符。

#### 工作原理

-   假设链路层使用某些特定的字节（例如 `0x7E`）作为帧的起始和结束标志。
-   如果数据中出现了 `0x7E`，链路层会将它转义为另一个字节（如 `0x7D 0x5E`），避免它被误认为是帧的边界。
-   接收方收到数据后，会知道这些转义字符，去掉它们，还原数据。

#### 举个例子

-   如果数据部分包含 `0x7E`，链路层会将其替换为 `0x7D 0x5E`。
-   接收方收到 `0x7D 0x5E` 时，知道应该还原为 `0x7E`。

# 什么是协议数据单元（PDU）

了解数据链路层之前我我们还需要了解一个概念——协议数据单元（PDU）。什么是协议数据单元（PDU）？

**协议数据单元（PDU）** 是指在网络通信中，数据在每一层协议中被封装后的单位。每一层协议都有其自己的PDU，用于在该层与其它设备交换数据。简而言之，PDU 是协议处理的数据块，不同层协议的 PDU 在结构和格式上是不同的。

最重要的是，他其实是数据在网络中从一层传递到另一层的过程的缩影。

## 各层协议的 PDU

-   **物理层**：物理层传输的是比特（Bit），因此物理层的 PDU 是 **比特**。
-   **数据链路层**：数据链路层将网络层传递下来的数据封装成 **帧（Frame）**，所以数据链路层的 PDU 是帧。
-   **网络层**：网络层负责将数据封装成 **数据包（Packet）**，所以网络层的 PDU 是数据包。
-   **传输层**：传输层将数据分为 **段（Segment）**（TCP协议）或 **数据报（Datagram）**（UDP协议），所以传输层的 PDU 是段或数据报。
-   **会话层、表示层、应用层**：这些层通常传输 **数据（Data）**，所以它们的 PDU 一般被称为数据。

## 举个例子

1. 网络层从上层接收到数据（比如应用层的数据），会将这些数据封装为 **数据包**，并附加必要的网络层信息，如目标IP地址。
2. 数据链路层则会将网络层的 **数据包** 封装为 **帧**，并附加链路层的信息（如MAC地址）。
3. 物理层再将这些 **帧** 转换成 **比特**，通过物理媒介发送。

## 数据链路层的帧是什么样的

虽然不同的网络协议可能有不同的帧结构，但一般来说，帧都包含以下几个部分：

-   **帧头（Header）**
    -   **目的地址（Destination MAC Address）**：接收设备的 MAC 地址。就像信封上的收件人地址，确保数据能到达正确的设备。
    -   **源地址（Source MAC Address）**：发送设备的 MAC 地址。类似信封上的发件人地址，让接收方知道是谁发送的。
    -   **类型（Type/Protocol）**：表明帧中携带的数据类型。例如，以太网帧会标明数据是上层的 IP 数据包还是 ARP 请求。
    -   **控制信息（Control Information）**：一些帧格式中可能包括如流量控制、优先级、顺序等信息，帮助处理数据传输中的细节。
-   **数据部分（Payload/Data）**
    -   这是帧的主要内容，包含了网络层传来的数据包（如 IP 数据包）。这部分数据将被封装在帧内部，并在数据链路层传输。
    -   数据部分的大小根据协议不同有所不同，但通常有一个最小值（例如，以太网帧的最小有效负载为 46 字节），否则帧可能会被填充。
-   **帧尾（Trailer）**
    -   **错误检测码（FCS/CRC）**：帧尾通常包含一个 **循环冗余校验（CRC）** 或 **帧校验序列（FCS）**，用来进行 **错误检测**。接收方会根据这个校验码检查数据是否在传输过程中出现了错误。如果错误检测码与接收到的内容不符，接收方会丢弃帧并请求重传。

# 数据链路层，在干啥？

数据链路层的任务是保证设备之间的通信能顺利进行。它就像是负责包裹的工作人员，确保数据被正确打包、检查、发送，并且没有错误。它控制了数据的流动速度，确保多个设备不会“抢”数据，保证数据能准确到达目的地。就像是为信息传输提供安全和高效的“道路”，确保一切顺畅进行。

## 帧的封装与解封装

### 为什么需要封装成帧？

网络层传输的是**数据包（Packet）**，而数据链路层需要将这个数据包封装成帧。帧不仅包含数据包的内容，还加上了数据链路层所需的控制信息（如地址、错误检测码等）。这样做的好处是：

-   **寻址**：确保数据能够传输到正确的设备。
-   **错误检测**：检查数据是否在传输过程中损坏。
-   **数据控制**：包括流量控制和介质访问控制等。

### 如何解封装

```tree
接收物理层数据（比特流）
         |
  数据链路层接收帧
         |
    检查目的地址 → 如果不匹配，丢弃帧
         |
   计算 FCS 校验 → 如果校验失败，丢弃帧
         |
     去除帧头和帧尾 - (去除以太网帧头和 FCS)
         |
   提取有效负载（上层数据包）
         |
    将数据传递给网络层
```

## 错误检测

错误检测主要发生在帧的解封装流程中，这里为了凸显出数据链路层的特性因此把他单独拿出来说。

首先我们要搞清楚 FCS 和 CRC 的概念。**FCS** 是帧检查序列，通常作为帧尾的一部分，在数据链路层用于检测在数据传输过程中是否发生了位错误。FCS 是一种冗余信息，它通过某种算法生成并附加到数据帧中，用于接收方验证数据的完整性。

而**CRC** 是一种常用的差错检测技术，它通过对数据帧进行数学运算（通常是除法运算），生成一个冗余值（校验码），然后将这个冗余值附加到数据后面作为帧的一部分。接收方在收到数据时，使用相同的 CRC 算法重新计算数据的校验码，并与接收到的 CRC 校验码进行比较。如果两者一致，则认为数据未发生错误；如果不一致，则说明数据在传输过程中发生了错误。

**CRC 是一种差错检测算法，而 FCS 是使用 CRC 算法计算出的校验码，并附加在数据帧中**。FCS 是实际在帧中传输的校验信息。

至于错误检测出来怎么办，这个就不归数据链路层管了。

### CRC 怎么计算

我看下面视频学会的（

<iframe src="//player.bilibili.com/player.html?isOutside=true&aid=713069598&bvid=BV1XX4y1M79c&cid=264454435&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
<iframe src="//player.bilibili.com/player.html?isOutside=true&aid=713069598&bvid=BV1XX4y1M79c&cid=264453700&p=2" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>

## 流量控制

### 为什么需要流量控制？

在通信中，发送方和接收方的处理能力往往是不一样的。如果发送方比接收方处理得更快，接收方的缓冲区可能会满，导致数据丢失。发送方一直以过快的速度发送数据，接收方无法及时处理，可能会造成网络拥塞，影响其他通信。

### 点对点信道的数据链路层流量控制

点对点信道指的是在两个设备之间直接进行通信的场景，如以太网的两个主机直接连接、串行通信、VPN连接等。在点对点信道中，流量控制通常关注的是 **发送方和接收方** 之间的数据流动，确保数据能够被有效且高效地传输。

#### 流量控制机制：

-   **滑动窗口协议（Sliding Window Protocol）**：常用于点对点的流量控制，特别是在 **全双工** 信道中（即双方可以同时发送和接收）。滑动窗口协议通过动态调整窗口的大小来控制发送方可以发送多少数据。
    在滑动窗口协议中，接收方会告诉发送方它的缓冲区可用空间（即窗口大小）。发送方根据窗口大小控制发送的数据量，确保不会超出接收方的接收能力。
-   **停等协议（Stop-and-Wait）**：另一种常见的流量控制机制。在这种协议中，发送方每发送完一个数据帧后会停止，等待接收方的确认（ACK）消息。如果接收方的缓冲区满了，它会通过确认消息告诉发送方暂停发送数据，直到接收方有足够的空间。

### 广播信道的数据链路层流量控制

广播信道指的是多个设备共享同一个传输信道，数据从一个发送方广播到多个接收方的情景。例如，以太网中的广播通信、Wi-Fi 无线网络等，都是典型的广播信道。广播信道的特点是发送方会向网络中所有设备发送数据，可能导致多个接收方同时接收到数据。

#### CSMA/CD（Carrier Sense Multiple Access with Collision Detection）

用于以太网中的广播信道，主要解决的是发送方如何避免与其他设备的冲突。虽然它不是严格意义上的流量控制机制，但它通过监听信道并检测冲突来减少流量的无效发送，避免了数据的过度发送。

CSMA/CD 工作流程如下：

1. 发送方在发送数据前首先监听信道，确保信道空闲。
2. 如果信道空闲，则开始发送数据。如果信道繁忙，发送方将等待。
3. 冲突检测：当发送方开始发送数据时，数据链路层的MAC子层会**监控信道**，并通过物理层的信号传输来检测信道是否发生冲突。如果冲突发生，MAC层会**检测到信号不一致**，即自己发送的信号与接收到的信号不匹配。一旦冲突被检测到，MAC层会通过物理层发送冲突信号（在物理层以电气信号的形式传播），然后**中止发送**并开始重试机制。
4. 如果发生数据碰撞，发送方会暂停一段时间后重新发送。
   ![image.png](https://cloud.intro-iu.top:738/d/ThreeBody/ZeroHzzzzPic/202412031817335.png)

-   在 t ＝ 0 时，A 发送数据。B 检测到信道为空闲。
-   在 t ＝ τ − δ 时（这里 τ > δ > 0 ），A 发送的数据还没有到达 B 时，由于 B 检测到信道是空闲的，因此 B 发送数据。
-   经过时间 δ / 2 后，即在 t ＝ τ − δ / 2 时，A 发送的数据和 B 发送的数据发生了碰撞。但这时 A 和 B 都不知道发生了碰撞。
-   在 t ＝ τ 时，B 检测到发生了碰撞，于是停止发送数据。
-   在 t ＝ 2 τ − δ 时，A 也检测到发生了碰撞，因而也停止发送数据。
-   A 和 B 发送数据均失败，它们都要推迟一段时间再重新发送。

那么问题来了，碰撞之后，什么时候重发呢？

#### 二进制指数类型退避算法

其基本思想就是设备在检测到冲突后等待一个随机的时间间隔再尝试重新发送数据，**时间间隔是以“倍数递增”的方式选择的**，即随着重试次数的增加，等待的随机时间间隔范围逐渐变大。这种递增范围是以 **指数增长** 的方式实现的。

# 数据链路层使用的信道

在数据链路层中，**信道**（Channel）通常指的是数据在网络中传输的媒介或路径。它是物理设备和通信协议之间的一种逻辑或物理连接通道，用于在网络中的设备之间传递数据。信道可以是物理的（如电缆、光纤、无线电波等），也可以是逻辑上的（如虚拟连接、交换机、路由器等设备之间的路径）。

## 数据链路层如何使用信道

数据链路层的主要任务是在网络设备之间提供可靠的数据传输。这是通过信道来完成的。
