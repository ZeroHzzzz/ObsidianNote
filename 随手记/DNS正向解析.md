[[DNS]] 正向解析是[[域名]]系统（Domain Name System）中最基础、最核心的功能，其目标是将人类可读的**域名（Domain Name）**转换为机器可用的**IP 地址（IP Address）**。这一过程是一个分层、分布式、递归和迭代协同工作的查询过程。

## 解析请求的起点：Stub Resolver

当用户在浏览器中输入 `www.example.com` 后，操作系统中的应用程序（如浏览器）会调用一个名为 **Stub Resolver** 的库函数。这个 Stub Resolver 首先会检查本地 DNS [[缓存]]。

- **如果命中缓存**：它会直接返回 IP 地址，整个过程结束，速度最快。
- **如果未命中缓存**：它会将查询请求发送给预先配置好的 **递归 DNS 服务器（Recursive DNS Server）**，通常由你的互联网服务提供商（ISP）提供。

## 递归 DNS 服务器的查询过程

递归 DNS 服务器是整个解析流程的“代理人”。它不会直接回复你，而是代表你去向其他 DNS 服务器进行查询。这个查询过程遵循一个自上而下的树状结构：

1. **根域名服务器（Root Name Server）**：递归服务器首先会向全球 13 组根域名服务器之一发送查询请求。根服务器不包含具体的域名信息，但它会告诉递归服务器 `.com` 域名的下一级服务器（顶级域名服务器）的地址。
2. **顶级域名服务器（[[TLD]] Name Server）**：递归服务器得到 `.com` TLD 服务器的地址后，会向其发送查询请求。这个 TLD 服务器会告诉它 `example.com` 域名的下一级服务器（权威域名服务器）的地址。
3. **权威域名服务器（Authoritative Name Server）**：这是存储着 `example.com` 所有 DNS 记录的服务器。递归服务器会向它发送最终查询请求，例如 `www` 子域名的 IP 地址。权威服务器会直接返回 `www.example.com` 对应的 IP 地址。

这个从根服务器到权威服务器的查询过程是**迭代查询（Iterative Query）**，因为每个服务器都只返回下一级服务器的地址，而不直接提供答案。而递归服务器代表用户完成整个查询过程，所以这个过程被称为**递归查询（Recursive Query）**。

## 结果的返回与缓存

权威服务器返回 IP 地址后：

1. 递归 DNS 服务器会将这个 IP 地址缓存起来，以便下次有相同查询时能快速响应。缓存的有效期由记录的 **TTL（Time to Live）** 值决定。
2. 它将结果返回给最初发起请求的 Stub Resolver。
3. Stub Resolver 也会将结果存入本地缓存，然后将 IP 地址交给应用程序。

至此，应用程序（浏览器）获得了 IP 地址，可以开始与目标服务器建立连接，加载网页内容。

## DNS 查找的 8 个步骤

DNS正向解析可以总结为8个步骤：

1. 用户在 Web 浏览器中键入 “example.com”，查询传输到 Internet 中，并被 DNS 递归解析器接收。
2. 接着，解析器查询 DNS 根域名服务器（.）。
3. 然后，根服务器使用存储其域信息的顶级域（[[TLD]]）DNS 服务器（例如 .com 或 .net）的地址响应该解析器。在搜索 example.com 时，我们的请求指向 .com TLD。
4. 然后，解析器向 .com TLD 发出请求。
5. TLD 服务器随后使用该域的域名服务器 example.com 的 IP 地址进行响应。
6. 最后，递归解析器将查询发送到域的域名服务器。
7. example.com 的 IP 地址而后从域名服务器返回解析器。
8. 然后 DNS 解析器使用最初请求的域的 IP 地址响应 Web 浏览器。

DNS 查找的这 8 个步骤返回 example.com 的 IP 地址后，浏览器便能发出对该网页的请求：

10. 浏览器向该 IP 地址发出 [HTTP](https://www.cloudflare.com/learning/ddos/glossary/hypertext-transfer-protocol-http/) 请求。
11. 位于该 IP 的服务器返回将在浏览器中呈现的网页（第 10 步）。
