主板固件（Firmware）是存储在主板上的一种特殊软件，它的核心作用是在电脑通电后，在操作系统开始加载之前，完成所有必要的初始化工作。

主要任务有：

- 硬件自检与初始化（POST）
- 为操作系统提供与硬件通信的底层接口， 这使得操作系统无需了解每个硬件的复杂细节，就能通过固件提供的统一接口来控制硬件
- 启动引导，它会根据预设的启动顺序（比如硬盘、U盘、光驱等），在第一个找到的设备上寻找操作系统的引导文件，然后将控制权移交给操作系统。

这里有两个熟悉的名词：BIOS和UEFI，都是主板固件的不同版本。

BIOS 是线性的，UEFI 是并行的。BIOS 是通过一个中间人（MBR）来启动系统，而 UEFI 则是直接找到并启动操作系统的引导文件。这就是为什么 UEFI 启动更快、更安全的原因。

## BIOS(基本输入/输出系统)

BIOS 是一个很古老的技术...

- **工作模式：** 在 16 位模式下运行，这限制了它只能管理最多 1MB 的内存。
- **硬盘支持：** 只能使用 [[分区表#MBR（主引导记录）|MBR]] 分区表，最大只能管理 2TB 的硬盘。
- **界面：** 通常是简陋的蓝色或灰色文本界面，只能用键盘操作。
- **速度：** 启动过程相对较慢，因为它需要按顺序逐一初始化硬件。

BIOS 的工作方式比较古老和线性。你可以把它想象成一个逐条执行命令的清单：

1. **开机自检（POST）：** 电脑通电后，BIOS 会立即运行。它会检查所有核心硬件，比如 CPU、内存、显卡和键盘，确认它们是否都连接正常。如果发现问题，会发出蜂鸣声警报。
2. **加载中断处理程序：** BIOS 会在内存（ROM）中设置一些中断处理程序（Interrupt Handlers），这些程序是操作系统与硬件通信的基础，其实也就是硬件驱动。
3. **寻找引导设备：** BIOS 会按照你预设的启动顺序，去寻找第一个可引导的设备（比如硬盘、U盘等）。
4. **读取 MBR：** 如果找到了硬盘，BIOS 会从硬盘的第一个扇区（称为 MBR，主引导记录）中读取一个很小的程序。
5. **移交控制权：** 最后，BIOS 将控制权交给 MBR 中的这个程序。这个程序会负责加载操作系统的引导文件，然后启动操作系统。

## UEFI(统一可扩展固件接口)

UEFI 是为现代电脑设计的，是 BIOS 的继任者

- **工作模式：** 运行在 32 位或 64 位模式下，可以管理和利用更大的内存。
- **硬盘支持：** 使用 [[分区表#GPT(全局唯一标识分区表)|GPT]] 分区表，可以管理超过 2TB 的超大容量硬盘。
- **界面：** 通常是图形化的，支持鼠标操作，界面更友好。
- **速度：** 启动速度更快，因为它可以并行初始化多个硬件。
- **安全性：** 提供了 “[[安全启动]]”（Secure Boot） 功能，可以防止恶意软件在操作系统加载前进行篡改。

UEFI 的工作方式更现代、更灵活。它不是一个简单的清单，而更像一个功能丰富的微型操作系统：

1. **初始化硬件：** UEFI 固件启动，同样会进行硬件自检和初始化，但它能**并行**执行这些任务，所以速度比 BIOS 快得多。
2. **加载驱动程序：** UEFI 可以在自己的环境中直接加载和运行驱动程序，这些驱动程序被称为 **EFI 驱动**。这使得它能够直接识别和操作硬件，比如鼠标、键盘、触摸屏，甚至网络。
3. **验证安全启动：** 如果开启了安全启动（Secure Boot），UEFI 会检查操作系统的引导文件是否带有可信的[[数字签名]]。如果验证通过，才允许继续。
4. **读取 GPT：** UEFI 会去寻找硬盘上的 **GPT**（GUID 分区表）
5. **直接加载引导文件：** UEFI 会在 GPT 分区中找到一个名为 EFI 系统分区（ESP)的独立分区。在这个分区里，它能够直接找到操作系统的引导文件，比如 Windows 的 `bootmgfw.efi`。
6. **移交控制权：** UEFI 直接加载并运行这个 `.efi` 引导文件，然后将控制权移交给操作系统。

### 寻找GPT

上面UEFI启动的过程给我带来了一个问题，就是UEFI 怎么找到 GPT的。

在此之前我们需要知道硬盘的物理结构。一个硬盘是由许多被称为扇区（Sector）的微小存储单元组成的，每个扇区通常是 512 字节或 4KB。这些扇区从 0 开始，依次编号。UEFI 寻找 GPT 的过程非常直接和高效，主要分两步：

- 寻找 GPT Header
    UEFI 固件被编程为在启动时，直接去硬盘的**第二个扇区（扇区 1）**寻找一个特定的数据结构，这个数据结构就是 **GPT Header**。他就像是 GPT 分区表的“目录”，它包含了所有分区的信息，比如有多少个分区、每个分区的大小和起始位置，以及分区表的备份位置等等。
- 读取分区表
    一旦 UEFI 固件找到了并验证了这个 GPT Header，它就知道分区表的位置。它会根据 Header 里的信息，去读取并加载整个 **GPT 分区表**。有了这个分区表，UEFI 固件就可以直接识别硬盘上的所有分区，特别是它要找的 **EFI 系统分区（ESP）**。

GPT 其实还有一个备份机制，不仅在硬盘开头（扇区 1）有主分区表，还在硬盘**末尾**有一个**备份分区表**。这意味着即使开头的分区表损坏了，UEFI 也可以从末尾的备份中恢复，极大地增强了数据的安全性。而 MBR 只有一份，一旦损坏就很难恢复，而且他是一整个程序，备份也不是很现实。

UEFI 的优势在于**跳过了中间环节**。它不需要先启动一个位于扇区 0 的小代码（MBR），再让这个小代码去找操作系统。BIOS的弊端就是如果 MBR 被损坏了，BIOS 就无法启动。而UEFI这样即使GPT 损坏了，由于备份机制的存在，在多数情况下还是能正常启动。

### CSM 兼容性支持模块

它是 **UEFI 固件**的一个功能

UEFI 是一个现代的、功能强大的固件，它取代了老旧的 BIOS。但是，很多用户仍然拥有使用老式技术的硬件和软件。为了解决这个问题，主板制造商在 UEFI 固件中加入了 CSM。它的主要目的就是让新的 UEFI 主板能够**兼容**这些老旧的技术

#### 工作原理

当你启用 CSM 后，UEFI 固件会“假装”成一个传统的 BIOS，从而能够：

1. **识别 MBR 分区：** 它会像 BIOS 一样，去寻找 MBR 分区表并读取主引导记录，来加载操作系统。
2. **使用 BIOS 驱动：** 它会加载和执行那些为 BIOS 模式编写的硬件驱动程序。

其实就是额外提供一个旧的 BIOS 接口，让你可以在新硬件上继续使用老旧的操作系统和设备。缺点也是有的，就是启用 CSM 会增加启动时间，因为它需要额外加载兼容模块。还有就是没办法使用安全启动。

因此我们新设备一般选择把他关掉。
